<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶</title>
  <link rel="stylesheet" href="static/css/store.css" />
  <link rel="manifest" href="static/manifest.json">
</head>
<body>
<header class="header-store">
  <div class="top-bar">
    <button onclick="logout()" class="logout-btn">â¬‹ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <button onclick="window.location.href='all_products.html'" class="btn-key">ğŸ›ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  </div>
  
  <div class="store-info">
    <img id="storeLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±" class="store-logo" onerror="this.style.display='none'">
    <h1 id="storeOwnerDisplay">...</h1>
  </div>
  <div class="store-actions">
    <button onclick="window.location.href='upload_logo.html'" class="btn-green">ğŸ–¼ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±</button>
    <button onclick="window.location.href='change_password.html'" class="btn-key">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
    <button onclick="requestNotificationPermission()" class="btn-key">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>

  </div>
</header>
<!-- âœ… ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª Ø²Ø§Ø¦Ø± ÙˆÙ„ÙŠØ³ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ØªØ¬Ø± -->
<div id="backToAllProducts" style="display:none; text-align:center; margin: 10px;">
  <button onclick="window.location.href='all_products.html'" class="btn-key">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
</div>

<div id="notificationBar" style="display:none; background:#fff3cd; color:#856404; padding:10px; text-align:center; font-weight:bold; border-bottom:1px solid #ffeeba">
  ğŸ“£ Ø¥Ø´Ø¹Ø§Ø±: ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯!
</div>
<div class="category-tabs" id="tabsContainer"></div>
<main class="products-grid" id="productsContainer"></main>
<footer class="bottom-nav">
  <button onclick="goToUpload()">â• Ø±ÙØ¹ Ù…Ù†ØªØ¬</button>
  <button onclick="goToManageTabs()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© </button>
</footer>
<div id="mediaModal" onclick="if(event.target.id==='mediaModal') closeMediaModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999;">
  <div id="mediaContent" style="width: 100%; text-align: center;"></div>
</div>
<script>
const BASE_URL = "https://offer-me.onrender.com";
const urlParams = new URLSearchParams(window.location.search);
let userId = urlParams.get('user_id') || localStorage.getItem('user_id');
const highlightId = urlParams.get('highlight');

if (!userId) {
  window.location.href = 'login.html';
}
localStorage.setItem('user_id', userId);
const fullName = localStorage.getItem('full_name');
const storeTitle = document.getElementById('storeOwnerDisplay');
if (highlightId) {
  fetch(`${BASE_URL}/settings/${userId}`)
    .then(res => res.json())
    .then(data => {
      storeTitle.innerHTML = `ğŸ­ Ù…ØªØ¬Ø± ${data.full_name || data.name || userId}`;
    });
} else {
  storeTitle.innerHTML = `ğŸ­ Ù…ØªØ¬Ø± ${fullName || userId}`;
}

function logout() {
  localStorage.clear();
  window.location.href = 'login.html';
}
function goToUpload() { window.location.href = 'upload.html'; }
function goToManageTabs() { window.location.href = 'manage_tabs.html'; }
function expandPost(id, link) {
  const postDiv = document.getElementById('post-' + id);
  postDiv.classList.toggle('expanded');
  link.textContent = postDiv.classList.contains('expanded') ? "Ø¹Ø±Ø¶ Ø£Ù‚Ù„" : "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯";
}
function openMediaModal(mediaUrl, isVideo) {
  const modal = document.getElementById('mediaModal');
  const content = document.getElementById('mediaContent');
  content.innerHTML = isVideo ?
    `<video src="${mediaUrl}" autoplay controls playsinline style="max-width: 80vw; max-height: 60vh; border-radius: 10px;"></video>` :
    `<img src="${mediaUrl}" style="max-width: 80vw; max-height: 60vh; border-radius: 10px;">`;
  modal.style.display = 'flex';
}
function closeMediaModal() {
  document.getElementById('mediaModal').style.display = 'none';
  document.getElementById('mediaContent').innerHTML = '';
}

async function loadProducts() {
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';
  try {
    const response = await fetch(`${BASE_URL}/products`);
    const products = await response.json();

    let filtered = products.filter(p => p.user_id === userId);

    // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø£ÙˆÙ„Ø§Ù‹
    filtered.sort((a, b) => {
      if (a.pinned && !b.pinned) return -1;
      if (!a.pinned && b.pinned) return 1;
      return 0;
    });

    if (highlightId) {
      const target = filtered.find(p => p.id === highlightId);
      if (target) {
        filtered = [target, ...filtered.filter(p => p.id !== highlightId)];
      }
    }

    if (!filtered.length) {
      container.innerHTML = '<p style="text-align:center; color:#777; margin-top:30px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
      return;
    }

    filtered.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      const post = product.post?.trim() || "";
      const safePost = post.replace(/`/g, "\\`").replace(/'/g, "\\'").replace(/"/g, '\\"'); // ÙÙ‚Ø· escape Ø¨Ø¯ÙˆÙ† <br>
      const postHTML = post ? `<div class="product-ai-post" id="post-${product.id}">${post}</div><span class="see-more" onclick="expandPost('${product.id}', this)">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</span>` : "";
      const isVideo = /\.(mp4|mov|webm)$/i.test(product.image);

      const media = isVideo ? `
        <div style="position:relative;">
          <video src="${product.image}#t=1" preload="metadata" muted playsinline
            style="width: 100%; max-height: 350px; object-fit: cover; border-radius: 8px; cursor: pointer;"
            onclick="event.stopPropagation(); openMediaModal('${product.image}', true)"></video>
          <div style="position:absolute; top:8px; right:8px; background:#000a; color:#fff; padding:4px 6px; border-radius:4px; font-size:12px;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</div>
        </div>
      ` : `<img src="${product.image}" alt="${product.name}" style="border-radius:8px; cursor:pointer;" onclick="openMediaModal('${product.image}', false)">`;

      card.innerHTML = `
        <div style="background:#ffffff; padding:0 16px 12px">${postHTML}</div>
        ${media}
        <div class="product-card-content">
          <h3>${product.name} ${product.price ? `- ${product.price} Ø±.Ù‚` : ''}</h3>
          <p class="product-description">${product.description}</p>
          <div class="share-buttons">
            <button class="copy-btn" data-post="${safePost}">ğŸ“‹ Ù†Ø³Ø®</button>
            <button onclick="event.stopPropagation(); sharePost(\`${safePost}\`)">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
           ${(!highlightId) ? `
           <button onclick="event.stopPropagation(); deleteProduct('${product.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
           <button onclick="event.stopPropagation(); pinProduct('${product.id}')">ğŸ“Œ ØªØ«Ø¨ÙŠØª</button>
        ` : ''}

           <span style="font-size: 14px;" ${highlightId ? `onclick="likeProduct('${product.id}')" style="cursor:pointer;"` : ''}>
             â¤ï¸ <span id="likes-${product.id}">0</span> Ø¥Ø¹Ø¬Ø§Ø¨
           </span>

          </div>
        </div>`;
      container.appendChild(card);
      loadLikes(product.id);
    });
  } catch (err) {
    container.innerHTML = '<p style="color:red; text-align:center;">âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</p>';
    console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:", err);
  }
}

document.addEventListener("click", function(e) {
  const btn = e.target.closest(".copy-btn");
  if (btn) {
    const rawText = btn.getAttribute("data-post") || "";
    const textarea = document.createElement("textarea");
    textarea.value = rawText.replace(/<br\s*\/?>/gi, "\n").replace(/&quot;/g, '"');
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand("copy");
      alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙˆØ³Øª Ø¨Ù†Ø¬Ø§Ø­");
    } catch (err) {
      alert("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®");
    }
    document.body.removeChild(textarea);
  }
});



function sharePost(text) {
  const cleanText = text.replace(/<br\s*\/?>/gi, "\n").replace(/&quot;/g, '"');
  const url = encodeURIComponent(window.location.href);
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${encodeURIComponent(cleanText)}`;
  window.open(shareUrl, '_blank');
}

async function deleteProduct(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
  const res = await fetch(`${BASE_URL}/delete-product/${id}`, { method: 'DELETE' });
  const result = await res.json();
  if (result.status === 'success') loadProducts();
}

async function pinProduct(id) {
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ØŸ")) return;
  const res = await fetch(`${BASE_URL}/pin-product/${id}`, { method: 'POST' });
  const result = await res.json();
  if (result.status === 'success') loadProducts();
}

function likeProduct(productId) {
  fetch(`${BASE_URL}/like/${productId}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      document.getElementById(`likes-${productId}`).textContent = data.likes;
    });
}

window.addEventListener('DOMContentLoaded', () => {
  if (!userId) return window.location.href = 'login.html';

  if (highlightId) {
    const actions = document.querySelector('.store-actions');
    const footer = document.querySelector('.bottom-nav');
    const logoutBtn = document.querySelector('.logout-btn');
    if (actions) actions.style.display = 'none';
    if (footer) footer.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'none';
  }

  const backBtn = document.getElementById('backToAllProducts');
  if (highlightId && backBtn) backBtn.style.display = 'block';

  fetch(`${BASE_URL}/settings/${userId}`)
    .then(res => res.json())
    .then(data => {
      if (data.logo) {
        document.getElementById('storeLogo').src = `${BASE_URL}${data.logo}?t=${Date.now()}`;
      }
    });

  loadProducts();
});


requestNotificationPermission();

function loadLikes(productId) {
  fetch(`${BASE_URL}/likes/${productId}`)
    .then(res => res.json())
    .then(data => {
      const likesSpan = document.getElementById(`likes-${productId}`);
      if (likesSpan) {
        likesSpan.textContent = data.likes || 0;
      }
    });
}
function requestNotificationPermission() {
  Notification.requestPermission().then(permission => {
    if (permission === 'granted') {
      importFirebaseMessaging(userId); // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ store.js
    } else {
      alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }
  });
}

</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(reg => {
        console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker:', reg);
      }).catch(err => {
        console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err);
      });
  }
</script>
<script>
  // âœ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(reg => console.log('âœ… Service Worker ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­:', reg.scope))
      .catch(err => console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err));
  }
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('firebase-messaging-sw.js')
      .then(function(registration) {
        console.log('ğŸ“¦ Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­:', registration);
      }).catch(function(err) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err);
      });
  }
</script>
<script type="module" src="/static/js/store.js"></script>


</body>
</html>
